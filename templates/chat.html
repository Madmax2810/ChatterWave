<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="chat-container">
        <h2>Chat Room - Session: {{ session_key }}</h2>
        <div id="chat-box"></div>
        <input type="text" id="message-input" placeholder="Type your message...">
        <button id="send-btn">Send</button>
        <button id="leave-btn">Leave Chat</button>
        <button id="vtt-btn" style="background-color: blue; color: white;">VTT</button>
    </div>

    <script>
        var socket = io();
        var username = "{{ username }}";
        var session_key = "{{ session_key }}";
        var recording = false;
        var mediaRecorder;
        var audioChunks = [];

        // Join room
        socket.emit('join', {username: username, session_key: session_key});

        // Send message
        document.getElementById('send-btn').onclick = function() {
            var msg = document.getElementById('message-input').value;
            if (msg.trim() !== "") {
                socket.emit('message', {msg: msg, session_key: session_key});
                document.getElementById('message-input').value = '';
            }
        };

        // Receive message
        socket.on('message', function(data) {
            var chatBox = document.getElementById('chat-box');
            var p = document.createElement('p');
            p.innerHTML = data.msg;
            chatBox.appendChild(p);
        });

        // Leave chat
        document.getElementById('leave-btn').onclick = function() {
            socket.emit('leave', {username: username, session_key: session_key});
            fetch('/logout', { method: 'GET' }).then(() => {
                window.location.href = '/';  // Redirect to login page
            });
        };

        // Handle VTT (Voice-to-Text) button click
        document.getElementById('vtt-btn').onclick = async function() {
            var vttBtn = document.getElementById('vtt-btn');

            if (!recording) {
                vttBtn.innerHTML = 'Initializing...';
                vttBtn.style.backgroundColor = 'orange';

                // Initialize Vosk
                const initResponse = await fetch('/initialize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (initResponse.ok) {
                    vttBtn.innerHTML = 'Stop';
                    vttBtn.style.backgroundColor = 'red';
                    recording = true;

                    // Start recording
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            mediaRecorder = new MediaRecorder(stream);
                            mediaRecorder.start();

                            mediaRecorder.ondataavailable = function(event) {
                                audioChunks.push(event.data);
                            };
                        }).catch(err => {
                            console.error('Error accessing the microphone: ', err);
                        });
                } else {
                    console.log('Vosk initialization failed');
                }
            } else {
                // Stop recording
                mediaRecorder.stop();
                mediaRecorder.onstop = function() {
                    vttBtn.innerHTML = 'VTT';
                    vttBtn.style.backgroundColor = 'blue';
                    recording = false;

                    // Create a Blob and send to backend
                    var audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    var formData = new FormData();
                    formData.append('file', audioBlob, 'audio.webm');

                    // Upload audio for transcription
                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('message-input').value = data.text;
                    })
                    .catch(err => console.error('Error uploading audio: ', err));
                };
            }
        };
    </script>
</body>
</html>
