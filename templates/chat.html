<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="chat-container">
        <h2>Chat Room - Session: {{ session_key }}</h2>
        <div id="chat-box"></div>
        <input type="text" id="message-input" placeholder="Type your message...">
        <button id="send-btn">Send</button>
        <button id="record-btn">ğŸ™ï¸ Record</button>
        <button id="leave-btn">Leave Chat</button>
    </div>

    <script>
        var socket = io();
        var username = "{{ username }}";
        var session_key = "{{ session_key }}";
        var mediaRecorder;
        var audioChunks = [];
        var isRecording = false;

        // Join room
        socket.emit('join', {username: username, session_key: session_key});

        // Send message
        document.getElementById('send-btn').onclick = function() {
            var msg = document.getElementById('message-input').value;
            if (msg.trim() !== "") {
                socket.emit('message', {msg: msg, session_key: session_key});
                document.getElementById('message-input').value = '';
            }
        };

        // Receive message
        socket.on('message', function(data) {
            var chatBox = document.getElementById('chat-box');
            var p = document.createElement('p');
            p.innerHTML = data.msg;
            chatBox.appendChild(p);
        });

        // Start/Stop recording audio
        document.getElementById('record-btn').onclick = async function() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        };

        // Function to start recording audio
        async function startRecording() {
            isRecording = true;
            document.getElementById('record-btn').innerText = 'ğŸ›‘ Stop';

            // Access microphone
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            // Capture audio data
            mediaRecorder.ondataavailable = function(event) {
                audioChunks.push(event.data);
            };

            // Start recording
            mediaRecorder.start();
        }

        // Function to stop recording and send audio to the server
        function stopRecording() {
            isRecording = false;
            document.getElementById('record-btn').innerText = 'ğŸ™ï¸ Record';
            
            // Stop the recording
            mediaRecorder.stop();

            // When the recording stops, send the audio to the backend for transcription
            mediaRecorder.onstop = function() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const formData = new FormData();
                formData.append('audio', audioBlob, 'audio.wav');

                // Send the audio to the backend
                fetch('/transcribe', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.transcription) {
                        // Set the transcribed text in the message input
                        document.getElementById('message-input').value = data.transcription;
                    } else {
                        console.error('Transcription failed:', data.error);
                    }

                    // Clear the audio chunks after sending
                    audioChunks = [];
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            };
        }

        // Leave chat
        document.getElementById('leave-btn').onclick = function() {
            socket.emit('leave', {username: username, session_key: session_key});
            fetch('/logout', { method: 'GET' }).then(() => {
                window.location.href = '/';  // Redirect to login page
            });
        };
    </script>
</body>
</html>
